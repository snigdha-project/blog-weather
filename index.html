<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webflow Blog Post Automator</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center">

    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">
            Webflow Blog Automator
        </h1>

        <p class="text-sm text-gray-600 mb-4">
            Click the button below to generate a new blog post on "Indian Weather" using the OpenRouter AI and post it
            directly to your Webflow CMS.
        </p>

        <!-- 
          SECURITY WARNING: 
          These API keys are visible in the client-side code. 
          This is a security risk for production apps.
          For a tool like this hosted on Vercel, this might be acceptable
          if you restrict access, but it's not recommended.
          A backend (like Vercel Serverless Functions) is the secure way to handle keys.
        -->
        <div class="hidden" id="api-data">
            <span data-webflow-api="050c6875b21eb97be830595aba018a7bf8b6b2910e470fcb6f87c0f6dddcf6d2"></span>
            <span data-webflow-collection="68ad630402390e12a44bd543"></span>
            <span
                data-openrouter-api="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"></span>
            <span data-site-base-url="https://hamarakhet-7013b6.webflow.io"></span>
        </div>

        <button id="startButton"
            class="w-full bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-300 ease-in-out flex items-center justify-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path
                    d="M13.586 3.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0l-1.586-1.586a2 2 0 10-2.828 2.828l1.586 1.586a2 2 0 010 2.828l-3 3a2 2 0 01-2.828-2.828l3-3a2 2 0 012.828 0l1.586 1.586a2 2 0 102.828-2.828L13.586 3.586z" />
            </svg>
            <span>Start Automation</span>
        </button>

        <div id="statusArea" class="mt-6 text-sm text-gray-700">
            <!-- Status messages will appear here -->
        </div>
    </div>

    <script>
        // --- 1. DOM Elements ---
        const startButton = document.getElementById('startButton');
        const statusArea = document.getElementById('statusArea');
        const apiData = document.getElementById('api-data');

        // --- 2. API Configuration ---
        const WEBFLOW_API_KEY = apiData.querySelector('[data-webflow-api]').dataset.webflowApi;
        const WEBFLOW_COLLECTION_ID = apiData.querySelector('[data-webflow-collection]').dataset.webflowCollection;
        const OPENROUTER_API_KEY = apiData.querySelector('[data-openrouter-api]').dataset.openrouterApi;
        const SITE_BASE_URL = apiData.querySelector('[data-site-base-url]').dataset.siteBaseUrl;

        const WEBFLOW_API_URL = `https://api.webflow.com/collections/${WEBFLOW_COLLECTION_ID}/items?live=true`;
        const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";

        // --- 3. Event Listener ---
        startButton.addEventListener('click', startAutomation);

        // --- 4. Helper Functions ---

        /**
         * Updates the status area with a message.
         * @param {string} message - The message to display.
         * @param {string} type - 'info', 'success', 'error', or 'loading'.
         */
        function showStatus(message, type = 'info') {
            let colorClass = 'text-gray-700';
            let icon = '';

            switch (type) {
                case 'success':
                    colorClass = 'text-green-600';
                    icon = '✅ ';
                    break;
                case 'error':
                    colorClass = 'text-red-600';
                    icon = '❌ ';
                    break;
                case 'loading':
                    colorClass = 'text-indigo-600';
                    icon = '<div class="spinner inline-block mr-2"></div>';
                    break;
                case 'info':
                default:
                    colorClass = 'text-gray-700';
                    icon = 'ℹ️ ';
            }

            statusArea.innerHTML = `
                <div class="p-4 rounded-lg bg-gray-50 border border-gray-200 ${colorClass}">
                    <div class="flex items-center">
                        ${icon}
                        <span class="font-medium">${message}</span>
                    </div>
                </div>
            `;
        }

        /**
         * A simple fetch wrapper to demonstrate API calls.
         * In a real app, add retry logic, exponential backoff, etc.
         */
        async function apiFetch(url, options) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, body: ${errorBody}`);
                }
                return await response.json();
            } catch (error) {
                console.error("Fetch Error:", error);
                throw error;
            }
        }

        // --- 5. Main Automation Logic ---

        async function startAutomation() {
            startButton.disabled = true;
            startButton.classList.add('opacity-50', 'cursor-not-allowed');
            statusArea.innerHTML = ''; // Clear previous status

            try {
                // --- Step 1: Generate Blog Content via OpenRouter ---
                showStatus('Generating blog content with AI... (This may take a moment)', 'loading');

                // We use Claude 3 Haiku for speed, cost, and excellent JSON output.
                const llmModel = "anthropic/claude-3-haiku-20240307";

                // This prompt is critical. It asks the AI to generate all fields in a single JSON response.
                const llmPrompt = `
                You are an expert blog post writer and SEO specialist. Your task is to generate all necessary content for a new blog post about the current weather in India. You MUST return ONLY a single, valid JSON object (no explanations, no markdown ticks \`\`\`) with the following structure and constraints:

                {
                  "name": "A catchy, human-readable blog post title (e.g., 'India's Weather Today: Monsoon Updates & Farming News').",
                  "slug": "A keyword-researched, URL-friendly slug. Lowercase, hyphen-separated. Max 5-7 words. (e.g., 'india-weather-report-monsoon-farming').",
                  "metaTitle": "An SEO-optimized meta title, strictly between 30 and 45 characters.",
                  "metaDescription": "An SEO-optimized meta description, strictly between 120 and 145 characters.",
                  "imageAlt": "A detailed, SEO-friendly alt text for an image of an Indian weather map. (e.g., 'Detailed weather map of India showing current monsoon patterns and state temperatures.')",
                  "postBodyHtml": "The full blog post content as an HTML string.
                      - Start with an H2 heading for the main topic.
                      - Include 2-3 paragraphs of engaging introduction.
                      - MUST include an H2 section titled 'All-India Weather Report'.
                      - Under this H2, MUST include an HTML table with plausible current weather data for ALL 28 states of India.
                      - The table must have columns: 'State', 'Capital', 'Temperature (°C)', 'Forecast'.
                      - The table header (<thead><tr>) MUST have this inline style: style="background-color: #FBC02D; color: #333;".
                      - MUST include an H2 section titled 'Weather Alerts and Farming News'.
                      - Under this H2, add an H3 subsection titled 'Weather Alerts' with 1-2 paragraphs.
                      - Under this H2, add another H3 subsection titled 'Chatpata Farming Weather Content' (interesting, spicy news for farmers) with 1-2 paragraphs.
                      - The last heading in the article must be an H3.
                      - Do NOT use any em dashes (—). Use a regular hyphen (-) if needed.
                      - All text must be wrapped in <p>, <h2>, <h3>, or <table> tags.",
                  "jsonSchema": "A complete JSON-LD NewsArticle schema for this post. Include headline, datePublished (use today's date in YYYY-MM-DDTHH:MM:SSZ format), author, publisher, etc. Format this as a JSON string."
                }
                `;

                const openRouterResponse = await apiFetch(OPENROUTER_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: llmModel,
                        messages: [
                            { role: "user", content: llmPrompt }
                        ],
                        response_format: { type: "json_object" } // Request JSON output
                    })
                });

                const blogContent = JSON.parse(openRouterResponse.choices[0].message.content);
                showStatus('AI content generated successfully!', 'success');

                // --- Step 2: Prepare Webflow Data ---
                showStatus('Preparing data for Webflow...', 'loading');

                // --- Image Workaround ---
                // Webflow's CMS API cannot ingest images from an external URL directly into an "Image Field".
                // We are assuming your "Main image" field is a "Plain Text" field where you store the URL.
                // We'll use Unsplash to get a dynamic, relevant image with the correct 4:5 ratio.
                const unsplashImageUrl = "https://source.unsplash.com/1080x1350/?india,weather,map,monsoon";

                // --- Field Name Assumption ---
                // This script assumes your Webflow Collection field *slugs* are:
                // 'name', 'slug', 'main-image', 'meta-title', 'meta-description', 'post-body', 'image-alt-text', 'schema'
                // If your slugs are different (e.g., "post-body-html"), you MUST change them in the payload below.

                const webflowPayload = {
                    "fields": {
                        "name": blogContent.name,
                        "slug": blogContent.slug,

                        // Assumes 'main-image' is a PLAIN TEXT field for the URL
                        "main-image": unsplashImageUrl,

                        // Assumes 'image-alt-text' is a PLAIN TEXT field
                        "image-alt-text": blogContent.imageAlt,

                        "meta-title": blogContent.metaTitle,
                        "meta-description": blogContent.metaDescription,

                        // Assumes 'post-body' is a PLAIN TEXT (multi-line) field, NOT Rich Text.
                        // You can then render this HTML on your site.
                        "post-body": blogContent.postBodyHtml,

                        // Assumes 'schema' is a PLAIN TEXT (multi-line) field.
                        "schema": blogContent.jsonSchema,

                        "_archived": false,
                        "_draft": false
                    }
                };

                // --- Step 3: Post to Webflow ---
                showStatus('Publishing post to Webflow...', 'loading');

                const webflowResponse = await apiFetch(WEBFLOW_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${WEBFLOW_API_KEY}`,
                        'accept-version': '1.0.0',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webflowPayload)
                });

                const postUrl = `${SITE_BASE_URL}/post/${webflowResponse.slug}`;
                showStatus(`Success! Blog post published. <br> <a href="${postUrl}" target="_blank" class="font-bold text-indigo-600 underline">View Post: ${postUrl}</a>`, 'success');

                // --- Step 4: Email Notification ---
                // As requested, you wanted an email sent.
                // IMPORTANT: Sending email directly from client-side JavaScript (in a browser)
                // is not possible for security reasons (it would expose email server credentials).
                // You must use a backend service like EmailJS, SendGrid, or a Vercel Serverless Function
                // to handle the email sending part.

                const emailMessage = `
                    <div class="p-4 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-800">
                        <div class="flex items-center">
                            ℹ️ 
                            <span class="font-medium ml-2"><strong>Email Notification:</strong> This step cannot be completed from the browser. You must set up a backend service (like EmailJS or a Vercel function) to send the email to 'snigdhachandrapaik@gmail.com'.</span>
                        </div>
                    </div>
                `;
                statusArea.innerHTML += emailMessage;


            } catch (error) {
                console.error('Automation Failed:', error);
                showStatus(`Automation Failed: ${error.message}`, 'error');
            } finally {
                // Re-enable the button
                startButton.disabled = false;
                startButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    </script>
</body>

</html>